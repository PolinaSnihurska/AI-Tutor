# Logstash configuration for AI Tutoring Platform

input {
  # File input for service logs
  file {
    path => "/var/log/services/*/combined.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "service-log"
  }
  
  file {
    path => "/var/log/services/*/error.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "error-log"
  }
  
  # Syslog input
  syslog {
    port => 5000
    type => "syslog"
  }
  
  # TCP input for direct log shipping
  tcp {
    port => 5001
    codec => json_lines
    type => "tcp-log"
  }
}

filter {
  # Parse timestamp
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss:SSS" ]
    target => "@timestamp"
  }
  
  # Add service name from file path
  if [type] == "service-log" or [type] == "error-log" {
    grok {
      match => { "path" => "/var/log/services/%{DATA:service}/" }
    }
  }
  
  # Parse log level
  mutate {
    uppercase => [ "level" ]
  }
  
  # Add environment tag
  mutate {
    add_field => { "environment" => "${ENVIRONMENT:development}" }
  }
  
  # Parse error stack traces
  if [level] == "ERROR" and [stack] {
    mutate {
      add_tag => [ "has_stack_trace" ]
    }
  }
  
  # Extract user ID if present
  if [userId] {
    mutate {
      add_tag => [ "has_user_context" ]
    }
  }
  
  # Tag slow requests
  if [duration] and [duration] > 2000 {
    mutate {
      add_tag => [ "slow_request" ]
    }
  }
  
  # Tag failed requests
  if [statusCode] and [statusCode] >= 500 {
    mutate {
      add_tag => [ "server_error" ]
    }
  }
  
  if [statusCode] and [statusCode] >= 400 and [statusCode] < 500 {
    mutate {
      add_tag => [ "client_error" ]
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{service}-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Output errors to separate index
  if [level] == "ERROR" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "errors-%{service}-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # Debug output (optional, remove in production)
  # stdout { codec => rubydebug }
}
